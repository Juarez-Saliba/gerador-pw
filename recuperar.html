<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Recuperar senha • PW</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="logo-wrap">
          <img id="pwLogo" class="logo-img hidden" alt="PW Leilões" />
          <div class="logo">PW</div>
        </div>
        <div class="brand-text">
          <span>Gerador de plaquinhas para leilão</span>
        </div>
      </div>
      <div class="user-actions">
        <button class="btn ghost hidden">Sair</button>
      </div>
    </header>
    <main class="panel auth">
      <div class="auth-card">
        <div class="tabs" style="justify-content:center">
          <button class="tab active">Recuperar senha</button>
        </div>
        <form id="resetForm" class="form visible" autocomplete="off">
          <label>
            <span>E-mail</span>
            <input type="email" name="email" required />
          </label>
          <label>
            <span>Nova senha</span>
            <input type="password" name="newPassword" required minlength="4" />
          </label>
          <button class="btn primary" type="submit">Salvar nova senha</button>
        </form>
        <div id="resetStatus" class="status hidden">
          <img src="./logo/logo_two.png" alt="PW Leilões" class="status-logo" onerror="this.style.display='none'">
          <span id="resetStatusText"></span>
          <div class="status-timer"></div>
        </div>
      </div>
    </main>
    <script>
      const API_BASE = '';
      const $ = (q) => document.querySelector(q);
      const show = (el) => el && el.classList.remove('hidden');
      const hide = (el) => el && el.classList.add('hidden');
      (async () => {
        const el = $('#pwLogo');
        if (!el) return;
        const candidates = [
          'logo/logo_two.png','LOGO/logo_two.png',
          'logo/pw.png','logo/pw.jpg','logo/pw.svg',
          'logo/logo.png','logo/logo.jpg','logo/logo.svg',
          'LOGO/pw.png','LOGO/pw.jpg','LOGO/pw.svg',
          'LOGO/logo.png','LOGO/logo.jpg','LOGO/logo.svg'
        ];
        for (const u of candidates) {
          try {
            const r = await fetch(u, { cache: 'no-store' });
            if (r.ok) {
              el.src = u;
              el.classList.remove('hidden');
              const fb = document.querySelector('.logo');
              if (fb) fb.classList.add('hidden');
              break;
            }
          } catch {}
        }
      })();
      function setStatus(text, ms) {
        const banner = $('#resetStatus');
        const textEl = $('#resetStatusText');
        textEl.textContent = text || '';
        const bar = banner.querySelector('.status-timer');
        if (bar) {
          bar.style.animation = 'none';
          bar.offsetHeight;
          bar.style.animation = `shrinkTimer ${ms/1000}s linear forwards`;
        }
        show(banner);
        setTimeout(() => { window.location.href = './index.html'; }, ms);
      }
      document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = e.target.email.value.trim().toLowerCase();
        const newPassword = e.target.newPassword.value;
        try {
          const res = await fetch(`${API_BASE}/api/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, newPassword })
          });
          const data = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(data.error || 'Falha ao resetar');
          hide(e.target);
          setStatus('Senha atualizada com sucesso', 5000);
        } catch (e2) {
          const banner = $('#resetStatus');
          const textEl = $('#resetStatusText');
          textEl.textContent = e2.message || 'Erro ao resetar senha';
          banner.classList.add('error');
          show(banner);
        }
      });
    </script>
  </body>
  </html>
